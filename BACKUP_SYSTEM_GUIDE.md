# Система бэкапов техкарт

## Обзор

Система автоматического бэкапа техкарт обеспечивает защиту данных от потери и возможность восстановления.

## Периодичность сохранения

### Автоматические бэкапы
- **При каждом обновлении техкарты** - создается автоматический бэкап
- **При каждом удалении техкарты** - создается автоматический бэкап перед удалением
- **Ручные бэкапы** - можно создать вручную через интерфейс

### Периодические бэкапы (планируется)
- Ежедневные бэкапы всех техкарт (через cron job или Supabase Edge Function)
- Еженедельные полные бэкапы

## Лимиты хранения

### Количество бэкапов
- **На одну техкарту**: максимум 10 автоматических бэкапов
- При превышении лимита удаляются самые старые незащищенные бэкапы
- Защищенные бэкапы не удаляются автоматически

### Срок хранения
- **Автоматические бэкапы**: 90 дней (по умолчанию)
- **Ручные бэкапы**: без ограничений (если не указан срок)
- **Защищенные бэкапы**: без ограничений

## Место хранения

### База данных
- **Таблица**: `recipes_backup` в Supabase PostgreSQL
- **Хранение**: JSONB формат (компактное и быстрое)
- **Размер**: автоматически рассчитывается при создании

### Безопасность
- **RLS (Row Level Security)**: включен
- **Доступ**: только аутентифицированные пользователи
- **Удаление**: только незащищенные бэкапы могут быть удалены автоматически
- **Защита**: можно защитить важные бэкапы от автоматического удаления

## Защита данных

### От случайного удаления
1. **Защита бэкапов**: флаг `is_protected` предотвращает автоматическое удаление
2. **Подтверждение удаления**: удаление техкарты требует подтверждения
3. **Автоматический бэкап**: перед удалением создается бэкап автоматически

### От постороннего доступа
1. **RLS политики**: только аутентифицированные пользователи имеют доступ
2. **Проверка прав**: удаление бэкапов ограничено (только незащищенные)
3. **Логирование**: все операции логируются

### Восстановление данных
1. **Восстановление из бэкапа**: можно восстановить техкарту из любого бэкапа
2. **Просмотр истории**: все бэкапы доступны для просмотра
3. **Статистика**: можно посмотреть статистику бэкапов

## Использование

### Создание ручного бэкапа
```typescript
await recipesService.createManualBackup(recipeId, 'Важное изменение');
```

### Восстановление из бэкапа
```typescript
const restored = await recipesBackupService.restoreFromBackup(backupId);
```

### Защита бэкапа
```typescript
await recipesBackupService.protectBackup(backupId);
```

### Очистка истекших бэкапов
```typescript
const deletedCount = await recipesBackupService.cleanupExpiredBackups();
```

## Мониторинг

### Статистика бэкапов
- Общее количество бэкапов
- Количество защищенных бэкапов
- Количество истекших бэкапов
- Общий размер бэкапов
- Дата самого старого и нового бэкапа

### Рекомендации
1. Регулярно проверяйте статистику бэкапов
2. Защищайте важные бэкапы
3. Очищайте истекшие бэкапы для экономии места
4. Создавайте ручные бэкапы перед важными изменениями

## Автоматическая очистка

### Настройка cron job (рекомендуется)
```sql
-- Запускать ежедневно в 2:00 ночи
SELECT cron.schedule(
    'cleanup-expired-backups',
    '0 2 * * *',
    $$SELECT cleanup_expired_backups()$$
);
```

### Ручная очистка
Вызовите функцию `cleanup_expired_backups()` в Supabase SQL Editor.

## Миграция

Для применения улучшений выполните:
```sql
-- В Supabase SQL Editor
\i migrations/improve_recipes_backup.sql
```

